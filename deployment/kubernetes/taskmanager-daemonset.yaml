apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: taskmanager
  namespace: stream-processing
  labels:
    app: taskmanager
spec:
  selector:
    matchLabels:
      app: taskmanager
  template:
    metadata:
      labels:
        app: taskmanager
    spec:
      serviceAccountName: stream-processing-sa
      containers:
      - name: taskmanager
        image: gcr.io/dcsc-project-479911/stream-processing-taskmanager:latest
        # Replace dcsc-project-479911 with your GCP project ID
        imagePullPolicy: Always
        ports:
        - containerPort: 6124
          name: grpc
        - containerPort: 9090
          name: metrics
        env:
        - name: TASK_MANAGER_ID
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: JOBMANAGER_HOST
          value: jobmanager
        - name: JOBMANAGER_PORT
          value: "6123"
        - name: TASKMANAGER_RPC_PORT
          value: "6124"
        - name: TASK_SLOTS
          valueFrom:
            configMapKeyRef:
              name: stream-processing-config
              key: TASK_SLOTS
        - name: MEMORY_SIZE
          valueFrom:
            configMapKeyRef:
              name: stream-processing-config
              key: MEMORY_SIZE
        - name: STATE_BACKEND
          valueFrom:
            configMapKeyRef:
              name: stream-processing-config
              key: STATE_BACKEND
        - name: KAFKA_BOOTSTRAP_SERVERS
          value: kafka-broker:9092
        - name: HEARTBEAT_INTERVAL
          valueFrom:
            configMapKeyRef:
              name: stream-processing-config
              key: HEARTBEAT_INTERVAL
        - name: HEARTBEAT_TIMEOUT
          valueFrom:
            configMapKeyRef:
              name: stream-processing-config
              key: HEARTBEAT_TIMEOUT
        - name: BUFFER_SIZE
          valueFrom:
            configMapKeyRef:
              name: stream-processing-config
              key: BUFFER_SIZE
        - name: BUFFER_POOL_SIZE
          valueFrom:
            configMapKeyRef:
              name: stream-processing-config
              key: BUFFER_POOL_SIZE
        - name: CREDIT_INITIAL
          valueFrom:
            configMapKeyRef:
              name: stream-processing-config
              key: CREDIT_INITIAL
        - name: ROCKSDB_WRITE_BUFFER_SIZE
          valueFrom:
            configMapKeyRef:
              name: stream-processing-config
              key: ROCKSDB_WRITE_BUFFER_SIZE
        - name: ROCKSDB_MAX_WRITE_BUFFERS
          valueFrom:
            configMapKeyRef:
              name: stream-processing-config
              key: ROCKSDB_MAX_WRITE_BUFFERS
        - name: ROCKSDB_BLOCK_CACHE_SIZE
          valueFrom:
            configMapKeyRef:
              name: stream-processing-config
              key: ROCKSDB_BLOCK_CACHE_SIZE
        - name: METRICS_PORT
          valueFrom:
            configMapKeyRef:
              name: stream-processing-config
              key: METRICS_PORT
        # GCS Configuration (for GCP)
        - name: STORAGE_BACKEND
          value: "gcs"
        - name: GCS_CHECKPOINT_PATH
          value: "gs://stream-processing-checkpoints-1764590836/checkpoints"
        - name: GOOGLE_APPLICATION_CREDENTIALS
          value: "/var/secrets/google/key.json"
        - name: POSTGRES_PORT
          value: "5432"
        resources:
          requests:
            memory: "4Gi"
            cpu: "1"
          limits:
            memory: "8Gi"
            cpu: "4"
        volumeMounts:
        - name: rocksdb-state
          mountPath: /data/rocksdb
        - name: gcp-key
          mountPath: /var/secrets/google
          readOnly: true
        startupProbe:
          tcpSocket:
            port: 6124
          initialDelaySeconds: 10
          periodSeconds: 5
          failureThreshold: 12
          timeoutSeconds: 3
        livenessProbe:
          tcpSocket:
            port: 6124
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 3
        readinessProbe:
          tcpSocket:
            port: 6124
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
      volumes:
      - name: rocksdb-state
        emptyDir: {}
      - name: gcp-key
        secret:
          secretName: gcp-service-account-key

